<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard de Ativações — CENTURY IRD (v5)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <style>
    html { scroll-behavior: smooth; }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <header class="px-6 py-5 bg-white shadow-sm sticky top-0 z-30">
    <div class="max-w-6xl mx-auto flex items-center justify-between">
      <h1 class="text-2xl font-semibold">Dashboard de Ativações — CENTURY IRD</h1>
      <nav class="hidden md:flex gap-6 text-sm">
        <a href="#resumo" class="hover:underline">Resumo</a>
        <a href="#filtros" class="hover:underline">Filtros</a>
        <a href="#graf-por-mes" class="hover:underline">Por mês</a>
        <a href="#graf-por-estado" class="hover:underline">Por estado</a>
        <a href="#graf-por-cidade" class="hover:underline">Por cidade</a>
        <a href="#tabelas" class="hover:underline">Tabelas</a>
      </nav>
    </div>
  </header>

  <main class="max-w-6xl mx-auto p-6 space-y-8">
    <section aria-labelledby="importacao" class="bg-white rounded-2xl shadow p-6">
      <h2 id="importacao" class="text-xl font-semibold mb-3">Importação do arquivo</h2>
      <p class="text-sm text-gray-600 mb-3">
        Compatível com o layout <strong>BASE_RETORNO_IRD_CENTURY.XLSX</strong> (colunas esperadas: <code>CAID</code>, <code>CIDADE_HABILITACAO</code>, <code>UF_HABILITACAO</code>, <code>DT_ATIVACAO</code>, opcional: <code>DT_RECARGA</code>, <code>RECHARGE_DS</code>, <code>FABRICANTE</code>).
      </p>
      <div class="flex flex-col md:flex-row items-start md:items-center gap-3">
        <input id="file" type="file" accept=".xlsx,.xls" class="block w-full md:w-auto text-sm file:mr-4 file:py-2 file:px-4 file:rounded-xl file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100" />
        <button id="btnPDF" class="px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700 text-sm">Exportar dashboard em PDF</button>
        <span id="status" class="text-sm text-gray-500"></span>
      </div>
      <p id="warnings" class="mt-2 text-xs text-amber-700"></p>
    </section>

    <section id="filtros" class="bg-white rounded-2xl shadow p-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold">Filtros</h2>
        <div class="flex items-center gap-2">
          <label class="text-sm text-gray-600">Tipo de gráfico:</label>
          <select id="chartType" class="text-sm border rounded-lg px-2 py-1">
            <option value="bar" selected>Barras</option>
            <option value="line">Linha</option>
            <option value="pie">Pizza</option>
          </select>
        </div>
      </div>
      <div class="grid md:grid-cols-4 gap-4">
        <div>
          <label class="block text-sm text-gray-600 mb-1">Data inicial</label>
          <input id="dtIni" type="date" class="w-full border rounded-lg px-3 py-2 text-sm" />
        </div>
        <div>
          <label class="block text-sm text-gray-600 mb-1">Data final</label>
          <input id="dtFim" type="date" class="w-full border rounded-lg px-3 py-2 text-sm" />
        </div>
        <div>
          <label class="block text-sm text-gray-600 mb-1">Estado (UF)</label>
          <select id="uf" class="w-full border rounded-lg px-3 py-2 text-sm"><option value="">Todos</option></select>
        </div>
        <div>
          <label class="block text-sm text-gray-600 mb-1">Cidade</label>
          <select id="cidade" class="w-full border rounded-lg px-3 py-2 text-sm"><option value="">Todas</option></select>
        </div>
      </div>
      <div class="mt-4 flex gap-3">
        <button id="btnAplicar" class="px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700 text-sm">Aplicar filtros</button>
        <button id="btnLimpar" class="px-4 py-2 rounded-xl bg-gray-100 hover:bg-gray-200 text-sm">Limpar</button>
      </div>
    </section>

    <section id="resumo" aria-labelledby="sec-resumo" class="grid md:grid-cols-3 gap-4">
      <div class="bg-white rounded-2xl shadow p-5">
        <div class="text-gray-500 text-xs">Registros lidos</div>
        <div id="kpiTotal" class="text-2xl font-semibold">—</div>
      </div>
      <div class="bg-white rounded-2xl shadow p-5">
        <div class="text-gray-500 text-xs">Registros válidos (chave única)</div>
        <div id="kpiValidos" class="text-2xl font-semibold">—</div>
        <div class="text-[10px] text-gray-400 mt-1">Se não houver SCUA/CARD_NR no arquivo, a chave passa a ser <strong>CAID</strong> (somente).</div>
      </div>
      <div class="bg-white rounded-2xl shadow p-5">
        <div class="text-gray-500 text-xs">Período</div>
        <div id="kpiPeriodo" class="text-sm">—</div>
      </div>
    </section>

    <section id="graf-por-mes" class="bg-white rounded-2xl shadow p-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold">Ativações por mês</h2>
        <button data-dl="mes" class="btn-dl px-3 py-1.5 rounded-lg text-sm bg-indigo-50 text-indigo-700 hover:bg-indigo-100">Baixar XLSX</button>
      </div>
      <canvas id="chartMes" height="120"></canvas>
    </section>

    <section id="graf-por-estado" class="bg-white rounded-2xl shadow p-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold">Ativações por estado (UF)</h2>
        <button data-dl="estado" class="btn-dl px-3 py-1.5 rounded-lg text-sm bg-indigo-50 text-indigo-700 hover:bg-indigo-100">Baixar XLSX</button>
      </div>
      <canvas id="chartEstado" height="120"></canvas>
    </section>

    <section id="graf-por-cidade" class="bg-white rounded-2xl shadow p-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold">Ativações por cidade</h2>
        <button data-dl="cidade" class="btn-dl px-3 py-1.5 rounded-lg text-sm bg-indigo-50 text-indigo-700 hover:bg-indigo-100">Baixar XLSX</button>
      </div>
      <canvas id="chartCidade" height="120"></canvas>
    </section>

    <section id="tabelas" class="bg-white rounded-2xl shadow p-6">
      <h2 class="text-lg font-semibold mb-4">Detalhes</h2>
      <div class="grid md:grid-cols-3 gap-6">
        <div>
          <h3 class="font-medium mb-2">Top meses</h3>
          <div class="overflow-auto max-h-80 border rounded-xl">
            <table id="tblMes" class="min-w-full text-sm">
              <thead class="bg-gray-50 sticky top-0">
                <tr><th class="text-left p-2">Mês</th><th class="text-right p-2">Ativações</th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
        <div>
          <h3 class="font-medium mb-2">Top estados</h3>
          <div class="overflow-auto max-h-80 border rounded-xl">
            <table id="tblEstado" class="min-w-full text-sm">
              <thead class="bg-gray-50 sticky top-0">
                <tr><th class="text-left p-2">Estado</th><th class="text-right p-2">Ativações</th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
        <div>
          <h3 class="font-medium mb-2">Top cidades</h3>
          <div class="overflow-auto max-h-80 border rounded-xl">
            <table id="tblCidade" class="min-w-full text-sm">
              <thead class="bg-gray-50 sticky top-0">
                <tr><th class="text-left p-2">Cidade</th><th class="text-right p-2">Ativações</th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <footer class="text-xs text-gray-500 text-center pb-12 space-y-2">
      <p>Chave primária: <span id="pkDef">CAID + SCUA</span>. Duplicados pela chave são desconsiderados.</p>
      <div class="flex justify-center gap-4">
        <span>Revisão: 1.1.0</span>
        <span>Data: 2025-09-25</span>
      </div>
    </footer>
  </main>

  <script>
    // Helpers
    const fmt = new Intl.NumberFormat('pt-BR');
    const fmtDate = (d) => d ? d.toISOString().slice(0,10) : '—';
    function toYYYYMM(date) {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, '0');
      return `${y}-${m}`;
    }
    function parsePossiblyExcelDate(value) {
      if (value == null || value === '') return null;
      if (typeof value === 'number') {
        const epoch = XLSX.SSF.parse_date_code(value);
        if (!epoch) return null;
        return new Date(Date.UTC(epoch.y, epoch.m - 1, epoch.d));
      }
      if (value instanceof Date) return value;
      const s = String(value).trim();
      const iso = new Date(s);
      if (!isNaN(iso)) return iso;
      const m = s.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
      if (m) {
        const [_, dd, mm, yyyy] = m;
        return new Date(Number(yyyy), Number(mm)-1, Number(dd));
      }
      return null;
    }
    function mapToSortedArray(objOrMap) {
      const entries = Array.isArray(objOrMap) ? objOrMap : Object.entries(objOrMap);
      return entries.sort((a,b) => b[1] - a[1]); // DESC
    }
    function downloadXLSX(filename, rows) {
      // Cria uma nova planilha a partir do array de objetos (JSON)
      const ws = XLSX.utils.json_to_sheet(rows);
      // Cria um novo workbook
      const wb = XLSX.utils.book_new();
      // Adiciona a planilha ao workbook com o nome 'Dados'
      XLSX.utils.book_append_sheet(wb, ws, 'Dados');
      // Escreve e dispara o download do arquivo XLSX
      XLSX.writeFile(wb, filename);
    }

    // Estado global
    let charts = { mes: null, estado: null, cidade: null };
    let agregados = { porMes: {}, porEstado: {}, porCidade: {} };
    let datasetBruto = []; // {dt, estado, cidade}
    let hasSCUA = false;

    function destruirGraficos() {
      for (const k of Object.keys(charts)) {
        if (charts[k]) { charts[k].destroy(); charts[k] = null; }
      }
    }
    function desenharTabela(tblId, dataPairs) {
      const tbody = document.querySelector(`#${tblId} tbody`);
      tbody.innerHTML = '';
      for (const [k, v] of dataPairs) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="p-2 pr-4" title="${k}">${k}</td><td class="p-2 text-right">${fmt.format(v)}</td>`;
        tbody.appendChild(tr);
      }
    }
    function desenharGrafico(canvasId, labels, values, titulo, tipo) {
      const ctx = document.getElementById(canvasId);
      return new Chart(ctx, {
        type: tipo,
        data: { labels, datasets: [{ label: titulo, data: values }] },
        options: {
          responsive: true,
          plugins: { legend: { display: tipo === 'pie' } },
          scales: (tipo === 'pie') ? {} : { y: { beginAtZero: true } }
        }
      });
    }
    function atualizarKPIs(total, validos, minDate, maxDate) {
      document.getElementById('kpiTotal').textContent = fmt.format(total);
      document.getElementById('kpiValidos').textContent = fmt.format(validos);
      document.getElementById('kpiPeriodo').textContent = (minDate && maxDate) ? `${fmtDate(minDate)} a ${fmtDate(maxDate)}` : '—';
    }

    function reagregarEDesenhar(base) {
      agregados = { porMes: {}, porEstado: {}, porCidade: {} };
      for (const { dt, estado, cidade } of base) {
        if (dt) {
          const ym = toYYYYMM(dt);
          agregados.porMes[ym] = (agregados.porMes[ym] || 0) + 1;
        }
        agregados.porEstado[estado] = (agregados.porEstado[estado] || 0) + 1;
        agregados.porCidade[cidade] = (agregados.porCidade[cidade] || 0) + 1;
      }
      destruirGraficos();
      // Ordenar por mês cronologicamente (não por quantidade)
      const porMesArr = Object.entries(agregados.porMes).sort((a,b) => a[0].localeCompare(b[0]));
      const porEstadoArr = mapToSortedArray(agregados.porEstado);
      const porCidadeArr = mapToSortedArray(agregados.porCidade);
      const tipo = document.getElementById('chartType')?.value || 'bar';
      const top20Cidades = porCidadeArr.slice(0, 20); // Top 20
      charts.mes = desenharGrafico('chartMes', porMesArr.map(x=>x[0]), porMesArr.map(x=>x[1]), 'Ativações por mês', tipo);
      charts.estado = desenharGrafico('chartEstado', porEstadoArr.map(x=>x[0]), porEstadoArr.map(x=>x[1]), 'Ativações por estado', tipo);
      charts.cidade = desenharGrafico('chartCidade', top20Cidades.map(x=>x[0]), top20Cidades.map(x=>x[1]), 'Ativações por cidade (Top 20)', tipo);
      desenharTabela('tblMes', porMesArr);
      desenharTabela('tblEstado', porEstadoArr);
      desenharTabela('tblCidade', porCidadeArr.slice(0, 100));
    }

    function popularFiltros(data) {
      const ufs = [...new Set(data.map(x => x.estado).filter(u => u && u !== '—'))].sort();
      const selUF = document.getElementById('uf');
      selUF.innerHTML = '<option value="">Todos</option>' + ufs.map(u => `<option value="${u}">${u}</option>`).join('');
      popularCidades(data, '');
      selUF.onchange = () => {
        popularCidades(data, selUF.value);
      };
    }
    function popularCidades(data, ufSel) {
      const cidades = [...new Set(data.filter(x => !ufSel || x.estado === ufSel).map(x => x.cidade).filter(c => c && c !== '—'))].sort();
      const selCidade = document.getElementById('cidade');
      selCidade.innerHTML = '<option value="">Todas</option>' + cidades.map(c => `<option value="${c}">${c}</option>`).join('');
    }
    function aplicarFiltrosERender() {
      if (!datasetBruto.length) return;
      const dtIniStr = document.getElementById('dtIni').value;
      const dtFimStr = document.getElementById('dtFim').value;
      const uf = document.getElementById('uf').value;
      const cidade = document.getElementById('cidade').value;
      const dtIni = dtIniStr ? new Date(dtIniStr) : null;
      const dtFim = dtFimStr ? new Date(dtFimStr) : null;
      const filtrado = datasetBruto.filter(x => {
        if (uf && x.estado !== uf) return false;
        if (cidade && x.cidade !== cidade) return false;
        if (dtIni && x.dt && x.dt < dtIni) return false;
        if (dtFim && x.dt && x.dt > dtFim) return false;
        return true;
      });
      reagregarEDesenhar(filtrado);
    }

    async function handleFile(file) {
      const status = document.getElementById('status');
      const warnings = document.getElementById('warnings');
      warnings.textContent = '';
      status.textContent = 'Lendo arquivo…';
      const ab = await file.arrayBuffer();
      const wb = XLSX.read(ab, { type: 'array', cellDates: true });

      // Junta todas as planilhas
      let rows = [];
      for (const sName of wb.SheetNames) {
        const ws = wb.Sheets[sName];
        const r = XLSX.utils.sheet_to_json(ws, { defval: null });
        rows = rows.concat(r);
      }

      const totalLidos = rows.length;
      const dedupMap = new Map();
      let minDate = null, maxDate = null;
      let missingKeys = new Set();

      // detecção de colunas neste layout
      const lower = (s) => String(s||'').toLowerCase().trim();
      const tryPick = (obj, names) => {
        for (const n of names) {
          for (const k of Object.keys(obj)) {
            if (lower(k) === lower(n)) return obj[k];
          }
        }
        return null;
      };

      let foundSCUA = false;

      for (const row of rows) {
        const CAID = tryPick(row, ['CAID','EQUIPMENT_NR']);
        const SCUA = tryPick(row, ['SCUA','CARD_NR']); // pode não existir neste layout
        const cidadeRaw = tryPick(row, ['CIDADE_HABILITACAO','ADDRESS_CITY_NM','CIDADE']);
        const estadoRaw = tryPick(row, ['UF_HABILITACAO','ADDRESS_STATE_CD','UF']);
        const dtRaw = tryPick(row, ['DT_ATIVACAO','ACCOUNT_CREATION_DT','DATA_ATIVACAO','account_creation_dt']);

        if (SCUA != null && String(SCUA).trim() !== '') foundSCUA = true;

        if (CAID == null) missingKeys.add('CAID');
        if (cidadeRaw == null) missingKeys.add('CIDADE_HABILITACAO');
        if (estadoRaw == null) missingKeys.add('UF_HABILITACAO');
        if (dtRaw == null) missingKeys.add('DT_ATIVACAO');

        if (CAID == null) continue;

        const pk = (SCUA != null && String(SCUA).trim() !== '') ? `${CAID}__${SCUA}` : `${CAID}`;
        if (dedupMap.has(pk)) continue;

        const dt = parsePossiblyExcelDate(dtRaw);
        const estado = (estadoRaw ?? '—').toString().trim() || '—';
        const cidade = (cidadeRaw ?? '—').toString().trim() || '—';

        dedupMap.set(pk, { dt, estado, cidade });

        if (dt) {
          if (!minDate || dt < minDate) minDate = dt;
          if (!maxDate || dt > maxDate) maxDate = dt;
        }
      }

      hasSCUA = foundSCUA;
      document.getElementById('pkDef').textContent = hasSCUA ? 'CAID + SCUA' : 'CAID';

      if (missingKeys.size) {
        warnings.textContent = 'Aviso: não foi possível encontrar em algumas linhas: ' + Array.from(missingKeys).join(', ') + '.';
      }

      const validos = dedupMap.size;
      datasetBruto = Array.from(dedupMap.values());

      atualizarKPIs(totalLidos, validos, minDate, maxDate);
      popularFiltros(datasetBruto);
      reagregarEDesenhar(datasetBruto);

      status.textContent = `Pronto. ${fmt.format(validos)} registros únicos.`;
    }

    // Eventos
    document.getElementById('file').addEventListener('change', (e) => {
      const f = e.target.files?.[0];
      if (!f) return;
      handleFile(f).catch(err => {
        console.error(err);
        document.getElementById('status').textContent = 'Erro ao processar o arquivo.';
      });
    });
    document.getElementById('btnAplicar').addEventListener('click', () => aplicarFiltrosERender());
    document.getElementById('btnLimpar').addEventListener('click', () => {
      document.getElementById('dtIni').value = '';
      document.getElementById('dtFim').value = '';
      const uf = document.getElementById('uf'); if (uf) uf.value = '';
      const cidade = document.getElementById('cidade'); if (cidade) cidade.value = '';
      reagregarEDesenhar(datasetBruto);
      document.getElementById('status').textContent = 'Filtros limpos.';
    });
    document.getElementById('chartType').addEventListener('change', () => {
      reagregarEDesenhar(datasetBruto);
    });

    document.getElementById('btnPDF').addEventListener('click', async () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: 'p', unit: 'pt', format: 'a4' });
      const alvo = document.querySelector('main');
      const canvas = await html2canvas(alvo, { scale: 2, useCORS: true });
      const img = canvas.toDataURL('image/png');
      const pageWidth = doc.internal.pageSize.getWidth();
      const pageHeight = doc.internal.pageSize.getHeight();
      const ratio = Math.min(pageWidth / canvas.width, pageHeight / canvas.height);
      const imgW = canvas.width * ratio;
      const imgH = canvas.height * ratio;
      doc.addImage(img, 'PNG', (pageWidth - imgW)/2, 20, imgW, imgH);
      doc.save('dashboard_ativacoes.pdf');
    });

    // Download dos XLSX
    document.querySelectorAll('.btn-dl').forEach(btn => {
      btn.addEventListener('click', () => {
        const tipo = btn.dataset.dl;
        const map = tipo === 'mes' ? agregados.porMes : tipo === 'estado' ? agregados.porEstado : agregados.porCidade;
        const rows = Object.entries(map).map(([k,v]) => ({ categoria: k, ativacoes: v }));
        const nome = `ativacoes_por_${tipo}.xlsx`;
        if (!rows.length) { document.getElementById('status').textContent = 'Sem dados para exportar.'; return; }
        downloadXLSX(nome, rows);
        document.getElementById('status').textContent = `XLSX gerado: ${nome}`;
      });
    });
  </script>
</body>
</html>
